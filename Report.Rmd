---
title: "Predicting Newborn Weight"
author: Liam Coleman-Aulenbach, Venessa Keung, Lucy Wang
output: pdf_document
documentclass: article
---

```{r setup, include=FALSE}
# Knitr Configuration
knitr::opts_chunk$set(include=FALSE, results="hide")
```

```{r import}
# Import
births <- read.csv("chds_births.csv")
```

# Summary

# Model Selection

## Data Diagnostic

### Data Exploration


```{r 1}
data <- read.csv("~/Downloads/chds_births.csv")

#lm(wt ~ I(fht - mht), data=data)
plot(data$fht - data$mht, data$wt)
plot(data$meth, data$wt, col=adjustcolor("firebrick", 0.5))
hist(data$wt, breaks=100)
pairs(data[c("wt", "mage", "mht", "income", "number")], col=adjustcolor("firebrick", 0.5))
plot(data$mwt / data$mht, data$wt)
#lm(wt ~ I(mwt/mht), data=data)
hist(data$mwt/data$mht, breaks=100)
plot(data$parity, data$wt)
#lm(wt ~ parity, data=data)
plot(data$med, data$wt, col=adjustcolor("firebrick", 0.5))
plot(data$fed, data$wt, col=adjustcolor("firebrick", 0.5))
plot(data$income, data$wt)
plot(data$med, data$fed, col=adjustcolor("firebrick", 0.5))
plot(data$mage, data$wt)
```

```{r height}
plot(data$mht, data$fht, col=adjustcolor("firebrick", 0.25))
abline(coef=c(0, 1))
plot(data$fht < data$mht, data$wt, col=adjustcolor("firebrick", 0.5))
mean(na.omit(data[data$fht < data$mht, ]$wt))
mean(na.omit(data[!(data$fht < data$mht), ]$wt))
```

```{r trial}
summary(lm(wt ~ gestation, data=data))
```

```{r pl}
plot(data$gestation, data$wt)
```


### Outliers
We discovered some values outside of the defined encodings. For example, in the marital column there were two 0s, which have no corresponding marital status. We overwrote those (likely) transcription errors with NAs which were later filled in with multiple imputation.
```{r outliers}
sum(na.omit(births$meth > 10 | births$meth < 0))
sum(na.omit(births$feth > 10 | births$meth < 0))
sum(na.omit(births$med > 7 | births$med < 0))
sum(na.omit(births$fed > 7 | births$med < 0))
sum(na.omit(births$marital > 5 | births$marital < 1))
sum(na.omit(births$income > 9 | births$income < 0))
sum(na.omit(births$smoke > 3 | births$smoke < 0))
sum(na.omit(births$time > 9 | births$time < 0))
sum(na.omit(births$number > 9 | births$number < 0))

mendedBirths <- data.frame(births)
mendedBirths[mendedBirths$marital == 0, "marital"] <- NA
```


### Missing Data

```{r NAs}
N <- nrow(mendedBirths)
round(sapply(colnames(mendedBirths), function (colname) sum(is.na(mendedBirths[colname])) / N), 2)

nrow(na.omit(mendedBirths[, !(colnames(mendedBirths) %in% c("fht", "fwt", "income"))])) / N
```

## Data Preprocessing

### Filling Missing Values

```{r mice}
library(mice)
m <- 5

multiplyImputedBirths <- mice(mendedBirths, m = m, method = "pmm", seed = 500, printFlag = FALSE)

imputedBirths <- lapply(1:m, function(i) complete(multiplyImputedBirths, i))
```


### Decoding

```{r preprocessData}
# Re-encoding and labelling variates
decodeBirthVariates <- function (birthsDataset) {
  newDataset = data.frame(birthsDataset)
  
  ethLabels <- c(
    "Caucasian",
    "Mexican",
    "African-American",
    "Asian",
    "Mixed",
    "Other"
  )
  edLabels <- c(
    "Elementary School",
    "Middle School",
    "High School",
    "High School + Trade School",
    "High School + Some College",
    "College Graduate",
    "Trade School",
    "High School Unclear"
  )

  newDataset$meth <- cut(
    birthsDataset$meth,
    breaks = c(0, 5:10), 
    labels = ethLabels,
    right = TRUE,
    include.lowest= TRUE
  )
  
  newDataset$med <- cut(
    birthsDataset$med,
    breaks = 0:8, 
    labels = edLabels,
    right = FALSE
  )
  
  newDataset$feth <- cut(
    birthsDataset$feth,
    breaks = c(0, 5:10),
    labels = ethLabels,
    right = TRUE,
    include.lowest= TRUE
  )
  
  newDataset$fed <- cut(
    birthsDataset$fed,
    breaks = 0:8, 
    labels = edLabels,
    right = FALSE
  )
  
  newDataset$smoke <- cut(
    birthsDataset$smoke,
    breaks = 0:4, 
    labels = c(
      "Never",
      "Smokes Now",
      "Until Pregnancy",
      "Doesn't Smoke Anymore"
    ),
    right = FALSE
  )
  
  newDataset$marital <- cut(
    birthsDataset$marital,
    breaks = 0:5, 
    labels = c(
      "Married",
      "Legally Separated",
      "Divorced",
      "Widowed",
      "Never Married"
    )
  )
  
  newDataset$number <- cut(
    birthsDataset$number,
    breaks = 0:10,
    labels = c(
      "Never Smoked",
      "1-4",
      "5-9",
      "10-14",
      "15-19",
      "20-29",
      "30-39",
      "40-60",
      "More Than 60",
      "Smoked But Don't Know How Much"
    ),
    right = FALSE
  )

  newDataset$time <- cut(
    birthsDataset$time,
    breaks = 0:10,
    labels = c(
      "Never Smoked",
      "Still Smokes",
      "During Pregnancy",
      "Less Than A Year",
      "1-2 Years",
      "2-3 Years",
      "3-4 Years",
      "5-9 Years",
      "More Than 10 Years",
      "Quit But Don't Know When"
    ),
    right = FALSE
  )

  newDataset$income <- cut(
    birthsDataset$income,
    breaks = c(0, 1, 2, 10),
    labels = c(
      "Under 2500",
      "2500-4999",
      "5000-Over 25000"
    ),
    right = FALSE
  )
  
  newDataset
}

decodedImputedBirths <- lapply(imputedBirths, decodeBirthVariates)
```

## Candidate Model 1

### Automated Model Selection

```{r selectModel}
meanAIC <- function (model, datasets) mean(sapply(
  datasets,
  function (dataset) AIC(update(model, data = dataset))
))

selectModel <- function (
  datasets,
  predictedVar,
  excludedVars = c(),
  specialTerms = c()
) {
  selectedModelMeanAIC = .Machine$integer.max
  selectedModel = NULL
  
  for (dataset in datasets) {
    #adjustedBirthsDataset <- birthsDataset[, !colnames(birthsDataset) %in% excludedVars]
    M0 = lm(wt ~ 1, data = dataset)
    Mmax = lm(
      formula(paste(
        predictedVar,
        "~",
        "(.",
        Reduce(function (l, r) paste(l, r), Map(function (term) paste("-", term), excludedVars), ""),
        ")^2",
        Reduce(function (l, r) paste(l, r), Map(function (term) paste("+", term), specialTerms), "")
      )),
      data = dataset
    )
    #Mmax <- lm(
    #  wt ~ (. - gestation - marital - time - meth - feth - med - fed)^2 + marital + time + meth + feth + med + fed,
    #  data = adjustedBirthsDataset
    #)
    #Mmax <- lm(wt ~ .^2, data = dataset)
    
    #checking if there are betas that are NA
    #beta.max <- coef(Mmax)
    #names(beta.max)[is.na(beta.max)]
    #anyNA(coef(Mmax))
  
    candidateModel = step(
      lm(wt ~ 1, data = dataset),
      scope = list(lower = M0, upper = Mmax),
      direction = "both",
      trace = 0
    )
  
    candidateModelMeanAIC = mean(sapply(
      datasets,
      function (dataset) AIC(update(candidateModel, data = dataset))
    ))
  
    if (candidateModelMeanAIC < selectedModelMeanAIC) {
      selectedModel = update(candidateModel, data = dataset)
      selectedModelMeanAIC = candidateModelMeanAIC
    }
  }
  
  selectedModel
}
```

```{r model1}
baseBirthWeightModel <- selectModel(
  decodedImputedBirths,
  "wt",
  c("gestation")
)
baseBirthWeightModelMeanAIC <- meanAIC(baseBirthWeightModel, decodedImputedBirths)
```

## Candidate Model 2

### Hand-crafted Features
```{r craftFeatures}
poundsToKg <- 0.453592
inchesToM <- 0.0254
underweightNormalBoundary <- 18.5
normalOverweightBoundary <- 25
overweightObeseBoundary <- 30
#obeseWeightGain <- mean(c(11, 20))
#overweightWeightGain <- mean(c(15, 25))
#normalWeightGain <- mean(c(25, 30))
#underweightWeightGain <- mean(c(28, 40))
isUnderweight <- function (x) x < underweightNormalBoundary
isNormal <- function (x) x < normalOverweightBoundary & x >= underweightNormalBoundary
isOverweight <- function (x) x < overweightObeseBoundary & x >= normalOverweightBoundary
isObese <- function (x) x >= overweightObeseBoundary

bmi <- function (wtLbs, htIn) (wtLbs * poundsToKg) / (htIn * inchesToM)^2
#obesePrePregnancyBMI <- function (pregnancyWt, ht) bmi(pregnancyWt - obeseWeightGain, ht)
#overweightPrePregnancyBMI <- function (pregnancyWt, ht) bmi(pregnancyWt - overweightWeightGain, ht)
#normalPrePregnancyBMI <- function (pregnancyWt, ht) bmi(pregnancyWt - normalWeightGain, ht)
#underweightPrePregnancyBMI <- function (pregnancyWt, ht) bmi(pregnancyWt - underweightWeightGain, ht)

prePregnancyBMI <- function (pregnancyWt, ht) {
  attemptOrder = sample(
    list(
      c(obesePrePregnancyBMI, isObese),
      c(overweightPrePregnancyBMI, isOverweight),
      c(normalPrePregnancyBMI, isNormal),
      c(underweightPrePregnancyBMI, isUnderweight)
    ),
    4
  )
  
  for (bmiCategoryPair in attemptOrder) {
    if (bmiCategoryPair[[2]](bmiCategoryPair[[1]](pregnancyWt, ht))) {
      return(bmiCategoryPair[[1]](pregnancyWt, ht))
    }
  }
}

weightFromBMI <- function (prePregnancyBMI, ht) {
  (1 / poundsToKg) * prePregnancyBMI * (ht * inchesToM)^2
}

smokingImpact <- function (time, number) {
  # There are no 9s in number, so we do not need to handle this case
  # Let's just call 8 a 1
  # 
  number[number == 8] <- 1
  cigaretteEffectRatio = 6
  # Take the average of the bounds of the range of cigarettes smoked by a given category
  # as the approximate exact number of cigarettes smoked per day
  numCigs = (number <= 4) * (5 * number - 2.5) + (number > 4) * (10 * number - 25.5)
  # https://www.med.uottawa.ca/sim/data/Smoking_and_Health_e.htm shows that it took a
  # six-fold increase in the number of cigarettes smoked a day to double the impact
  # on the likelihood of developing lung cancer. We approximate the effect of smoking
  # on birth with this ratio too.
  activeSmokingImpact = (number != 0) * 2^(number / cigaretteEffectRatio)
  
  impactTimeDecay = 2
  
  # Approximate a scalar number of years since quiting based on the categorical variable
  yearsQuit = (time >= 3) * (-2.5 + time) + (time >= 7) * (-18.5 + 3 * time)
  # Time = 1 or 2 are special cases with 0 decay
  yearsQuit = yearsQuit * (time >= 3)
  
  decayedSmokingImpact = activeSmokingImpact * exp(-yearsQuit / impactTimeDecay)
  
  decayedSmokingImpact
}

craftFeatures <- function (imputedBirthsDataset) {
  newDataset = decodeBirthVariates(imputedBirthsDataset)

  newDataset$sameEth <- factor(
    imputedBirthsDataset$meth == imputedBirthsDataset$feth,
    labels = c("Different", "Same")
  )
  # What about "Other" though?
  
  newDataset$htDiff <- newDataset$fht - newDataset$mht
    
  newDataset$lateMom <- factor(
    newDataset$parity == 0 & newDataset$mage >= 35,
    labels = c("Not late", "Late")
  )

  newDataset$mBMI <- bmi(newDataset$mwt, newDataset$mht)
  
  #newDataset$mwt <- weightFromBMI(newDataset$mBMI, newDataset$mht)
  
  newDataset$mBMICategory <- factor(
    1 * isNormal(newDataset$mBMI)
      + 2 * isOverweight(newDataset$mBMI)
      + 3 * isObese(newDataset$mBMI),
    labels = c("Underweight", "Normal", "Overweight", "Obese")
  )
  
  newDataset$smokingImpact <- smokingImpact(
    imputedBirthsDataset$time,
    imputedBirthsDataset$number
  )
  newDataset$smokingQuitCategory <- factor(
    1 * (imputedBirthsDataset$time == 2) + 2 * (imputedBirthsDataset$time == 1),
    labels = c("Before/Never", "During", "Continued")
  )
  
  newDataset
}

engineeredFeatureBirths <- lapply(imputedBirths, craftFeatures)
```


### Automated Model Selection
```{r model2}
engineeredBirthWeightModel <- selectModel(
  engineeredFeatureBirths,
  "wt",
  c("gestation", "smokingImpact", "smokingQuitCategory", "fht"),
  c("smokingImpact:smokingQuitCategory")
)
engineeredBirthWeightModelMeanAIC <- meanAIC(
  engineeredBirthWeightModel,
  engineeredFeatureBirths
)
```


# Model Diagnostics

## Significance


## AIC


## Cross-Validation
```{r crossValidate}
testSetRatio = 0.2

crossValidate <- function (model1, model2, datasets) {
  # "Usually about a 1000 is fine" - M. Lysy, Nov. 27, 2018
  m = 1000

  model1rPMSE <- vector(mode="numeric", length=m)
  model2rPMSE <- vector(mode="numeric", length=m)

  for (i in 1:m) {
    chosenSet = datasets[[sample(length(datasets), 1)]]
    Ntotal = nrow(data)
    Ntest = floor(N * testSetRatio)
    outOfSampleIndices = sample(N, Ntest)
    sample = chosenSet[-outOfSampleIndices, ]
    testSet = chosenSet[outOfSampleIndices, ]
    
    candidateModel1 = update(candidateModel1, data=sample)
    candidateModel2 = update(candidateModel2, data=sample)
    outOfSamplePredictions1 = predict(candidateModel1, newdata=testSet)
    outOfSamplePredictions2 = predict(candidateModel2, newdata=testSet)
    predictionErrors1 = (testSet$wt - outOfSamplePredictions1) ^ 2
    predictionErrors2 = (testSet$wt - outOfSamplePredictions2) ^ 2
    model1Errors[i] <- sqrt(sum(predictionErrors1) / Ntest)
    model2Errors[i] <- sqrt(sum(predictionErrors2) / Ntest)
  }
  
  data.frame(model1 = model1rPMSE, model2 = model2rPMSE)
}
```

# Discussion



# Appendix
```{r, ref.label=knitr::all_labels(), echo=TRUE, eval=FALSE, include=TRUE}
```
