---
title: "Predicting Newborn Weight"
author: Liam Coleman-Aulenbach, Venessa Keung, Lucy Wang
output: pdf_document
documentclass: article
header-includes:
  - \geometry{margin=0.75in}
---


```{r setup, include = FALSE}
# Knitr Configuration
knitr::opts_chunk$set(
  comment = NA,
  cache = TRUE,
  include = TRUE,
  echo = FALSE,
  results = "markup",
  fig.show = "asis",
  fig.height = 3.2,
  fig.align = "center"
)
```

```{r constants}
# Define all the functions and constants used later

# Category names for Ethnicity variates
ethLabels <- c(
  "Caucasian",
  "Mexican",
  "African-American",
  "Asian",
  "Mixed",
  "Other"
)

# Category names for Education variates
edLabels <- c(
  "Elementary School",
  "Middle School",
  "High School",
  "High School + Trade School",
  "High School + Some College",
  "College Graduate",
  "Trade School",
  "High School Unclear"
)

# Number of imputed datasets
k <- 5

# Unit conversion factors
poundsToKg <- 0.453592
inchesToM <- 0.0254

# The boundaries for BMI categories ("Pregnancy weight gain: What's healthy?", 2017)

underweightNormalBoundary <- 18.5
normalOverweightBoundary <- 25
overweightObeseBoundary <- 30

# Use test 20% for test set in cross validation
testSetRatio = 0.2

# Number of cross-validation trials
# "Usually about a thousand is fine" - M. Lysy, Nov. 27, 2018
m <- 1000
```

```{r bmiFunctions}
# Input: bmi - a BMI
# Output: TRUE/FALSE depending on if the BMI falls into category in function name
isUnderweight <- function (bmi) bmi < underweightNormalBoundary
isNormal <- function (bmi) bmi < normalOverweightBoundary &
                           bmi >= underweightNormalBoundary
isOverweight <- function (bmi) bmi < overweightObeseBoundary &
                               bmi >= normalOverweightBoundary
isObese <- function (bmi) bmi >= overweightObeseBoundary

# Input: wtLbs - weight in pounds
#        htIn - height in inches
# Output: (double) BMI
bmi <- function (wtLbs, htIn) (wtLbs * poundsToKg) / (htIn * inchesToM)^2
```

```{r numCigs}
# Roughly translate the "number" category to a floating point
# number of the actual number of cigarettes smoked
# Input: number - raw value for 'number' variable
# Output: (double) approximation of the number of individual cigarettes smoked per day
numCigs <- function (number) (number > 0 & number <= 4) * (5 * number - 2.5) +
                             (number > 4) * (10 * number - 25.5)
```

```{r decodeBirthVariates}
# Decode most categorical variates and encode them as labelled factors
# Decodes 'number' and converts it to a float using numCigs
# Decodes 'income' and converts it so a factor with 3 broader categories
# Returns a new data frame and does not modify the given one
# Input: birthsDataset - an imputed births dataset
# Output: a new data frame with factor encoded categorical variables
decodeBirthVariates <- function (birthsDataset) {
  newDataset = data.frame(birthsDataset)

  newDataset$meth <- cut(
    birthsDataset$meth,
    breaks = c(0, 5:10), 
    labels = ethLabels,
    right = TRUE,
    include.lowest= TRUE
  )

  newDataset$med <- cut(
    birthsDataset$med,
    breaks = 0:8, 
    labels = edLabels,
    right = FALSE
  )

  newDataset$feth <- cut(
    birthsDataset$feth,
    breaks = c(0, 5:10),
    labels = ethLabels,
    right = TRUE,
    include.lowest= TRUE
  )

  newDataset$fed <- cut(
    birthsDataset$fed,
    breaks = 0:8, 
    labels = edLabels,
    right = FALSE
  )

  newDataset$smoke <- cut(
    birthsDataset$smoke,
    breaks = 0:4, 
    labels = c(
      "Never",
      "Smokes Now",
      "Until Pregnancy",
      "Doesn't Smoke Anymore"
    ),
    right = FALSE
  )

  newDataset$marital <- cut(
    birthsDataset$marital,
    breaks = 0:5,
    labels = c(
      "Married",
      "Legally Separated",
      "Divorced",
      "Widowed",
      "Never Married"
    )
  )

  newDataset$number <- numCigs(birthsDataset$number)

  newDataset$time <- cut(
    birthsDataset$time,
    breaks = 0:10,
    labels = c(
      "Never Smoked",
      "Still Smokes",
      "During Pregnancy",
      "Less Than A Year",
      "1-2 Years",
      "2-3 Years",
      "3-4 Years",
      "5-9 Years",
      "More Than 10 Years",
      "Quit But Don't Know When"
    ),
    right = FALSE
  )

  newDataset$income <- cut(
    birthsDataset$income,
    breaks = c(0, 1, 2, 10),
    labels = c(
      "Under 2500",
      "2500-4999",
      "Over 5000"
    ),
    right = FALSE
  )

  newDataset
}
```

```{r smokingImpact}
# Input: time - time since quitting smoking in original integer encoding
#        number - number of cigarettes smoked in original integer encoding
#        impactHalfLife - the half-life of the smoking impact as it decays after quitting
# Output: (doubel) our custom smoking impact variate
smokingImpact <- function (time, number, impactHalfLife) {
  # Take the average of the bounds of the range of cigarettes smoked by a given category
  # as the approximate exact number of cigarettes smoked per day
  activeSmokingImpact = log(
    numCigs(number) +
    (number == 0) * 1 # This term guarantees a value of 0 for non-smokers (0 = log(1))
  )
  
  # Approximate a scalar number of years since quiting based on the categorical variable
  yearsQuit = (time >= 3) * (-2.5 + time) + (time >= 7) * (-18.5 + 3 * time)
  # Time = 1 or 2 are special cases with 0 decay
  yearsQuit = yearsQuit * (time >= 3)
  
  decayedSmokingImpact = activeSmokingImpact * 2^(-yearsQuit / impactHalfLife)
  
  decayedSmokingImpact
}
```

```{r engineeredFeatures}
# Input: imputedBirthsDataset - an imputed births dataset
#        impactHalfLife - the half-life parameter to supply when computing smokingImpact
# Output: a new data frame with factor encoded categorical variables and new engineered features
craftFeatures <- function (imputedBirthsDataset, impactHalfLife = 2) {
  newDataset = decodeBirthVariates(imputedBirthsDataset)

  # Note: This treats parents of "Other" ethnicity
  # as the same ethnicity though they may not be
  newDataset$sameEth <- factor(
    (imputedBirthsDataset$meth != 9 & # If they are both "Mixed" then it is like two
                                      # parents of different ethnicities
     imputedBirthsDataset$meth == imputedBirthsDataset$feth) |
    # Both Caucasian
    (imputedBirthsDataset$meth < 6 & imputedBirthsDataset$feth < 6),
    labels = c("Different", "Same")
  )
  
  newDataset$htDiff <- newDataset$fht - newDataset$mht
    
  # If a mother is having her first child after 40,
  # we say that she is becoming a mother late in life
  newDataset$lateMom <- factor(
    newDataset$parity == 0 & newDataset$mage >= 40,
    labels = c("Not late", "Late")
  )

  newDataset$mBMI <- bmi(newDataset$mwt, newDataset$mht)
  
  # Multiplying by 1, 2, and 3 to give integer encoding of
  # categories which are then changed to a factor
  newDataset$mBMICategory <- factor(
    1 * isNormal(newDataset$mBMI)
      + 2 * isOverweight(newDataset$mBMI)
      + 3 * isObese(newDataset$mBMI),
    labels = c("Underweight", "Normal", "Overweight", "Obese")
  )
  
  newDataset$smokingImpact <- smokingImpact(
    imputedBirthsDataset$time,
    imputedBirthsDataset$number,
    impactHalfLife
  )
  
  newDataset
}
```

```{r meanAIC}
# Input: model - a model
#        datasets - a collection of imputed datasets
# Output: (float) the average AIC of the model across the given datasets
meanAIC <- function (model, datasets) mean(sapply(
  datasets,
  function (dataset) AIC(update(model, data = dataset))
))
```

```{r selectModel}
# Input: datasets - a collection of imputed datasets
#        predictedVar - the variables to be predicted by the model
#        excludedVars - variables in the datasets to be ignored in model selection
#        specialTerms - specific terms to be allowed in the model (overrides exlusion)
# Output: an automatically selected model which fits predictedVar with variables
#         from the dataset
selectModel <- function (
  datasets,
  predictedVar,
  excludedVars = c(),
  specialTerms = c()
) {
  selectedModelMeanAIC = .Machine$integer.max
  selectedModel = NULL
  
  # Fit a model against each dataset and keep with one which performs best on all
  for (dataset in datasets) {
    M0 = lm(wt ~ 1, data = dataset)
    Mmax = lm(
      # Write maximal formula with interaction effects between all vars not excluded,
      # with added special terms on their own
      formula(paste(
        predictedVar,
        "~",
        "(.",
        Reduce(
          function (l, r) paste(l, r),
          Map(function (term) paste("-", term), excludedVars),
          ""
        ),
        ")^2",
        Reduce(
          function (l, r) paste(l, r),
          Map(function (term) paste("+", term), specialTerms),
          ""
        )
      )),
      data = dataset
    ) 
  
    candidateModel = step(
      lm(wt ~ 1, data = dataset),
      scope = list(lower = M0, upper = Mmax),
      direction = "both",
      trace = 0
    )
  
    candidateModelMeanAIC = meanAIC(candidateModel, datasets)
  
    if (candidateModelMeanAIC < selectedModelMeanAIC) {
      selectedModel = update(candidateModel, data = dataset)
      selectedModelMeanAIC = candidateModelMeanAIC
    }
  }
  
  selectedModel
}
```

```{r crossValidate}
# Input: model1 - a model
#        model2 - a model
#        datasets - datasets to cross-validate the models on
# Output: the rPMSE for each model on each cross-validation trial,
#         as well as a sample of actual values, predictions, and residuals
#         from the final trial
crossValidate <- function (model1, model2, datasets) {
  model1rPMSE <- vector(mode = "numeric", length = m)
  model2rPMSE <- vector(mode = "numeric", length = m)

  for (i in 1:m) {
    chosenSet = datasets[[1 + i %% k]]
    Ntotal = nrow(chosenSet)
    Ntest = floor(Ntotal * testSetRatio)
    outOfSampleIndices = sample(Ntotal, Ntest)
    trainSet = chosenSet[-outOfSampleIndices, ]
    testSet = chosenSet[outOfSampleIndices, ]
    
    model1 = update(model1, data = trainSet)
    model2 = update(model2, data = trainSet)
    outOfSamplePredictions1 = predict(model1, newdata = testSet)
    outOfSamplePredictions2 = predict(model2, newdata = testSet)
    predictionErrors1 = (testSet$wt - outOfSamplePredictions1) ^ 2
    predictionErrors2 = (testSet$wt - outOfSamplePredictions2) ^ 2
    model1rPMSE[i] <- sqrt(sum(predictionErrors1) / Ntest)
    model2rPMSE[i] <- sqrt(sum(predictionErrors2) / Ntest)
  }
  
  list(
    rPMSEs = data.frame(model1 = model1rPMSE, model2 = model2rPMSE),
    actual = testSet$wt,
    predictions = data.frame(
      model1 = outOfSamplePredictions1,
      model2 = outOfSamplePredictions2
    ),
    residuals = data.frame(
      model1 = outOfSamplePredictions1 - testSet$wt,
      model2 = outOfSamplePredictions2 - testSet$wt
    )
  )
}
```

```{r import}
# Import dataset
births <- read.csv("chds_births.csv")
```

```{r mend}
# The occurrences of marital == 0 are likely transcription errors.
# Replace them with NAs
mendedBirths <- data.frame(births)
mendedBirths[mendedBirths$marital == 0, "marital"] <- NA
```

```{r mice}
# Suppress library warnings
options(warn=-1)

# Multiple Imputation
library(mice, quietly = TRUE)

# For consistency
set.seed(331)

multiplyImputedBirths <- mice(
  mendedBirths,
  m = k,
  method = "pmm",
  printFlag = FALSE
)

# Gather the imputed datasets
imputedBirths <- lapply(1:k, function(i) complete(multiplyImputedBirths, i))
```

```{r decodeBirths}
# Decode the categorical variables into factors and replace number with
# numCigs so that we don't get linearly dependent categories for never smoked
# and smoked 0 cigarettes
decodedImputedBirths <- lapply(imputedBirths, decodeBirthVariates)
```

```{r tuneHalfLife, results = "hide"}
# The candidate values for half life
halfLifeValues <- seq(0.1, 10, by = 0.1)

# The half life value which maximized multiple R squared
optimalImpactHalfLife <- 0.1 * which.max(sapply(
  halfLifeValues,
  function (halfLife) summary(lm(
    wt ~ smokingImpact + time + numCigs,
    data = data.frame(
      wt = imputedBirths[[1]]$wt,
      time = imputedBirths[[1]]$time,
      numCigs = numCigs(
        imputedBirths[[1]]$number
      ),
      smokingImpact = smokingImpact(
        imputedBirths[[1]]$time,
        imputedBirths[[1]]$number,
        impactHalfLife = halfLife
      )
    )
  ))$r.squared
))

paste("Optimal impact half life:", optimalImpactHalfLife)
```

```{r craftFeatures}
library(purrr) # Needed for the function 'partial' used below
# Create datasets with our engineered features and the previous factor
# transformations from decodeImputedBirths as well, using the optimized
# impact half life value
engineeredFeatureBirths <- lapply(
  imputedBirths,
  partial(craftFeatures, impactHalfLife = optimalImpactHalfLife)
)
```


# Summary

The purpose of this study was to determine what factors affect a male baby's birth weight with information readily available when the couple conceives. A sample of 1236 newborn males was conducted from 1960-1967 and information was taken via a survey of the mothers. The factors considered in this study were mother's age, mother's weight, father's ethnicity, the amount of time since the mother had stopped smoking, and parity. Furthermore, we engineered variables showing the mothers' pregnancy BMI, a smoking index to reflect the affects of smoking on the mothers' bodies, whether or not the parents were of the same ethnicity, and the height difference between the father and the mother. These variables were created either because the given variates were not an accurate predictor of health, or because we thought they would also be predictors of a baby's weight. Results of the study show that the two factors most significant to a baby's birth weight are the mother's ethnicity and height.


# Model Selection

## Data Diagnostic

### Data Exploration

Looking at the data beforehand, we tried to test if any of the variables that would be assumed to have a relationship with baby weight had a relationship in the context of the data. 

```{r 1}
pairs(
  births[c("wt", "mht", "mwt", "time", "number")],
  col = adjustcolor("firebrick", 0.2),
  pch = 19,
  main = "Fig. 1.1: Pairs Plot"
)
```

We found that the babies' weight had a positive correlation with the mothers' weight as well as with the mothers' height. We also see that the mothers' weight has a positive correlation with the mothers' height.

We also tried to find the distribution of the babies' weight. In doing so, we tested to see if the babies' weight followed a Normal distribution. If it did not, we would have had to apply a transformation to the data to make it follow a Normal distribution.

```{r 2}
h<- hist(
  births$wt,
  breaks = 100,
  freq = FALSE,
  col = "firebrick",
  main = "Fig 1.2: Frequency of Birth Weights",
  xlab = "Birth Weight (ounces)",
  mar = c(1, 4, 1, 2) + 0.1
) 

curve(
  dnorm(x, mean(births$wt), sd(births$wt)),
  add = TRUE,
  lwd = 3, 
  col = "darkblue"
)
```

Looking at the data, we saw that the distribution of the babies' weight was close to Normal, but had spikes in frequency in certain areas. This likely corresponded to rounding and measurement discrepancies.

We then decided to test the correlation between the mothers' ethnicity and the babies' weight. According to a 2009 study published in the British Journal of Nutrition, BMI was found to be an inaccurate measurement for non-white individuals. BMI, as a measure of weight proportional to the area of an individual's body, was found to differ among races (Dovey, 2018). Hence, it seems to be a viable factor when considering the weight of a newborn baby.

However, based on the data, there was little or no correlation between only the mothers' ethnicity and the babies' weight. See Appendix 3.1.3 for plot.

Next, we tested for a relationship between parity and the babies' weight. As a mother's body adjusts to pregnancy, it would make sense for the babies' weight to be affected.

Based on the data, we saw that there was minimal correlation between only the babies' weight and parity. See Appendix 3.1.4 for plot.

Finally, we tested for a relationship between the mothers' education level, fathers' education level, mothers' age at the termination of the pregnancy, and household income with the babies' weight. A household with a higher income would be able to provide more resources to a pregnant mother and would have a higher likelihood of having a healthy mother, who would likely give birth a baby with a healthy birth weight. A household with a higher income would likely have a highly educated mother, highly educated father, or both.

Therefore, we tested for a relationship between mothers' education level and fathers' education level. A mother with a lower education level, which would not be uncommon given that the data was taken from 1960-1967, may have been more inclined to marry a man with a higher education level in order to provide for herself and a future child. She also would have wanted to give birth between her 20s and 30s, as that is when she is at her most fertile, and carries less risk in pregnancy.

However, we saw that the tested variables: mothers' education level, fathers' education level, mothers' age  at the termination of pregnancy, and household income have a very low or no correlation with the babies' weight. See Appendix 3.1.5 for plots.

We tried to test if any of the engineered variables: difference between father and mother height, and BMI, had a relationship with weight.

According to Stulp et al. 2011, it was found that a difference between parental height contributed to whether or not the mother would require an Emergency Cesarean Section (ECS). Since ECS can be used when a baby is too big for the birth canal or to save the baby in before it comes to term, there is a possibility that it is related to birth weight.

Looking at the heights of the mothers and the fathers, we saw that majority of the couples had fathers who were taller than the mothers. It was also worth nothing that the mean baby weight when the father was taller than the mother is greater than the mean baby weight when the mother is taller than the father. This suggested a possible correlation between the difference in heights.

```{r 6}
par(mfrow = c(1,2))
plot(
  births$mht,
  births$fht,
  col = adjustcolor("firebrick", 0.25),
  pch = 16,
  main = "Fig. 1.6.1: Mother vs Father Height",
  cex.main = 0.75,
  xlab = "Mother's Height (inches)",
  ylab = "Father's Height (inches)",
  cex.main = 0.65
)
abline(coef = c(0, 1))
plot(
  births$fht - births$mht,
  births$wt,
  pch = 16,
  col = adjustcolor("firebrick", 0.25),
  main = "Fig. 1.6.2: Difference in Height vs Weight",
  cex.main = 0.75,
  xlab = "Difference in Height (inches)",
  ylab = "Birth Weight (ounces)",
  cex.main = 0.65
)

mean(imputedBirths[[1]][imputedBirths[[1]]$mht > imputedBirths[[1]]$fht, "wt"])
mean(imputedBirths[[1]][imputedBirths[[1]]$mht <= imputedBirths[[1]]$fht, "wt"])
```

Based on the plot, there is no obvious relationship between the difference in parental height and the babies' weight.

BMI, as a relatively good indicator of health, would theoretically also be a good indicator of health of a newborn baby. We wanted to look at the mothers' BMI to see whether that would have a relationship with the baby's newborn weight.

```{r BMI}
plot(
  bmi(births$mwt, births$mht),
  births$wt,
  pch = 16,
  col = adjustcolor("firebrick", 0.25),
  main = "Fig. 1.7: Mother's BMI vs Birth Weight",
  xlab = "Mother's BMI (kg/m^2)",
  ylab = "Birth Weight (ounces)"
)
```

Based on the data, there appeared to be a small positive correlation between the mothers' BMI and the babies' weight.


We did not consider gestation as a factor of birth weight because it was not information that the couple could know at the time of conception of the baby. 

```{r gestation}
plot(
  births$gestation,
  births$wt,
  col = adjustcolor("firebrick", 0.25),
  main = "Fig. 1.8: Gestation Period vs Birth Weight",
  xlab = "Gestation Period (days)",
  ylab = "Birth Weight (ounces)",
  pch = 16
)
```

We also found that gestation was very closely related to births, indicating that predicting gestation period was conceptually similar to predicting birth weight.

### Outliers
We discovered some values outside of the defined encodings. For example, in the marital column there were two 0s, which have no corresponding marital status. We overwrote those (likely) transcription errors with NAs which were later filled in with multiple imputation.

```{r outliers}
paste("Table 1.9: Number of Occurrences per Marital Status category")
summary(factor(births$marital))
```

### Missing Data

We saw that 40% of the entries in both father's weight and father's height were NA, as well as 10% of the entries in income. Without father height, father weight, and income, the percentage of the original data considered would be reduced to 90.2%.

```{r NAs}
N <- nrow(mendedBirths)

paste("Table 1.10: Fraction of NAs by Variable")
round(
  sapply(
    colnames(mendedBirths),
    function (colname) sum(is.na(mendedBirths[colname])) / N
  ),
  2
)
nrow(na.omit(
  mendedBirths[, !(colnames(mendedBirths) %in% c("fht", "fwt", "income"))]
)) / N
```

## Data Preprocessing

### Filling Missing Values

All the data was included and values using MICE were substituted. The three aforementioned factors affected the baby's weight very minimally, but were included to preserve the integrity of the data. 

## Candidate Model 1

Model 1 was constructed using raw data with decoded categorical datasets. The automated selection process uses stepwise selection with direction set to both.

The model is as follows:

```{r model1}
basicBirthWeightModel <- selectModel(
  decodedImputedBirths,
  "wt",
  excludedVars = c("gestation", "smoke", "marital"),
  specialTerms = c("marital")
)
basicBirthWeightModelMeanAIC <- meanAIC(basicBirthWeightModel, decodedImputedBirths)
basicBirthWeightModel$call
```

## Candidate Model 2

For our second model, we decided to try engineered some features which we hypothesized have a meaningful relation to the birth weight of a baby. These engineered features include the difference between mother and father's heights (htDiff), whether the parents are the same ethnicity, whether the mother is having her first child late in life, the mother's BMI (mBMI), the mother's BMI category (mBMICategory), and smoking health impact (smokingImpact).

As explained preceding figures 1.6.1 and 1.6.2 in the Data Exploration sub-section, we know that the difference in the height of the parents can impact pregnancy outcomes. We thus decided to include this as an engineered factor.

According to a the study in Gold et al. (2010), babies of mixed race have a higher rate of low birth weight. We included a variate indicating whether the parents were the same ethnicity or not. We treated two parents of 'Other' ethnicity as being the same ethnicity, and if both parents were 'Mixed' ethnicity, then were categorized them as different ethnicity as well.

We suspected that the body composition of the mother is more predictive than a linear combination of her height and weight. Using BMI will allow the model to incorporate a more complex relationship between the weight and height of a mother. For example being underweight, regardless of your height, may impact your pregnancy and hence the weight of the baby. Since a scalar BMI will only represent a linear relationship between birth weight and BMI, we included BMI categories under the hypothesis that both being underweight and overweight could have a negative impact on the birth weight.

BMI is defined as $\frac{\textrm{weight (kg)}}{\textrm{height}^2 (\textrm{m}^2)}$

The mother's BMI category is defined as follows:

\begin{center}
\begin{tabular}{|c|c|}
\hline
BMI Category & Range ($kg/m^2$) \\
\hline
Underweight & <18.5 \\
Normal & [18.5, 25) \\
Overweight & [25, 30] \\
Obese & > 30 \\
\hline
\end{tabular}
\end{center}
  
We wanted to create a better combined measure of how the mother's smoking habits impact the pregnancy. We hypothesized that there existed a "diminishing returns" effect on the number of cigarettes smoked. ("Health Impact of Smoking", n.d.) demonstrates that it took a six-fold increase in the number of cigarettes smoked a day to double the increase of the likelihood multiplier of developing lung cancer. This is interpreted as evidence of a non-linear relationship, so we selected a logarithm of the number of cigarettes smoked as our measure of general health impact.

Secondly, we considered how the health impact fades after quitting smoking. We hypothesized that the health impact would decay exponentially over time as the body recovered. We constructed our smoking impact feature as the logarithm of the number of cigarettes smoked per day while smoking, decayed by the number of years since quitting (or preserved if smoking has continued or mother quit during pregnancy). This is parameterized by the "effect half-life" for the decay which had to be selected. We expected that the health impact on the mother of her smoking habits, which this function is supposed to represent, would have an impact on the health of the pregnancy and the weight of the baby.

The smoking impact is calculated as follows:
$$
\textrm{Smoking Impact} = \begin{cases}
 log(\alpha) * {2^{-{\beta}/{\lambda}}} &\textrm{ if } \gamma > 0\\
 0 &\textrm{ if } \gamma = 0
\end{cases}
$$
where ${\alpha}$ is the number of cigarettes smoked per day while smoking, $\beta$ is the number of years since quitting (0 if not having quit or having quit during pregnancy), and $\lambda$ is the health impact half life.

After running an experiment find the value for $\lambda$ which gave it the most explanatory power of the baby weight in the context of the existing time and number of cigarette variates, the value we obtained was 0.1 (Appendix 2.2.5). It was apparent that the smaller the value of $\lambda$, the higher the $R^2$ value we obtained. At values this small, the smoking impact becomes 0 regardless of whenever the smoker has quit. We interpreted this to mean that our measure of smoking impact did not add any explanatory power after the mother has quit smoking. However, it did still increase the $R^2$ when it was included with $\lambda = 0.1$, so we selected this value for the parameter.


The model is as follows:

```{r model2}
engineeredBirthWeightModel <- selectModel(
  engineeredFeatureBirths,
  "wt",
  excludedVars = c("gestation", "smoke", "time", "fht", "mBMICategory", "income",
                   "marital", "med", "fed", "meth", "feth", "htDiff", "lateMom"),
  specialTerms = c("time", "fht", "mBMICategory", "income",
                   "marital", "med", "fed", "meth", "feth", "htDiff", "lateMom")
)
engineeredBirthWeightModelMeanAIC <- meanAIC(
  engineeredBirthWeightModel,
  engineeredFeatureBirths
)
engineeredBirthWeightModel$call
```


# Model Diagnostics
 
## Summary Statistics

#### Table 2.1: Comparison of Model Fits
```{r summaryStatistics}
# residual standard error
basicRes <- summary(basicBirthWeightModel)$sigma
enginRes <- summary(engineeredBirthWeightModel)$sigma

#R squared calculation
basicRsquared <- summary(basicBirthWeightModel)$r.squared
enginRsquared <- summary(engineeredBirthWeightModel)$r.squared

#R squared adjusted
basicARsquared <- summary(basicBirthWeightModel)$adj.r.squared
enginARsquared <- summary(engineeredBirthWeightModel)$adj.r.squared

summaryTable <- data.frame(
  c(basicRes, enginRes),
  c(basicRsquared, enginRsquared),
  c(basicARsquared, enginARsquared)
)
colnames(summaryTable) <- c("Residual Standard Error", "R Squared", "Adjusted R Squared")
rownames(summaryTable) <- c("Basic Model", "Engineered Model")
summaryTable 
```

By comparing the Residual Standard Error in both the Basic and Engineered Model, we saw that the difference between them was not very large. However, we also saw that the Residual Standard Error for the Engineered Model was preferable to that of the Basic Model. Similarly, the difference between the $R^2$ values for both models did not differ by a large amount, but the $R^2$ value for the Engineered Model was more preferable than that of the Basic Model.

## Diagnostic Plots

### Basic Birth Weight Model

#### Figure 2.2: Basic Model Residuals
```{r plotDiagnostic1}
layout(matrix(c(1, 2, 4, 5), 1, 2, byrow = TRUE))
plot(
  basicBirthWeightModel,
  cex = 0.4,
  which = c(1, 2),
  pch = 19,
  col = adjustcolor("firebrick", 0.25),
  lwd = 2,
  main = NULL
)
```

### Engineered Birth Weight Model

#### Figure 2.3: Engineered Model Residuals
```{r plotDiagnostic2}
layout(matrix(c(1, 2, 4, 5), 1, 2, byrow = TRUE))
plot(
  engineeredBirthWeightModel,
  cex = 0.4,
  which = c(1, 2),
  pch = 19,
  col = adjustcolor("firebrick", 0.25),
  lwd = 2,
  main = NULL
)
```

Looking at the Residual and Fitted plot, both models did not exhibit any specific trend in the points, hence suggesting that there was a linear relationship present. Similar to the Residual plot, the Normal Q-Q plot also showed strong Normality. However, there was no significant evidence that one model exhibited better results than the other, hence additional diagnostics were required.

By looking at the plot of Cook's distance of the two models in Appendix 3.3.2 and Appendix 3.3.3, there were around the same number of high influential data points in both models. The Engineered Model's data was overall more influential compared to the Basic Model.

## PRESS Statistic and AIC

#### Table 2.4: Comparison of Models' AIC and PRESS
```{r PRESSandAIC}
press1 <- resid(basicBirthWeightModel) / (1 - hatvalues(basicBirthWeightModel)) 
press2 <- resid(engineeredBirthWeightModel) / (1 - hatvalues(engineeredBirthWeightModel))
AIC1 <- c("Basic", "Engineered")

#display results
disp <- rbind(
  AIC = c(
    engineeredBirthWeightModelMeanAIC,
    basicBirthWeightModelMeanAIC),
    PRESS = c(sum(press1^2), sum(press2^2)
  )
)
colnames(disp) <- c("Basic", "Engineered")
disp
```

Looking at the PRESS statistic and the AIC of both models, AIC favoured the Basic Model, while the PRESS statistic favoured the Engineered Model. However the PRESS statistic had a larger relative difference in the two models compared to AIC, so overall the Engineered Model was preferred using these statistical analyses.

Looking at the PRESS statistic and the AIC of both models, AIC is favouring the Basic Model, while the PRESS statistic favours the Engineered Model. However the PRESS statistic has a larger relative difference in the two models compared to AIC, so overall the Engineered Model is preferred using these statistical analysis.

## Cross-Validation
```{r crossValidation}
cvResults <- crossValidate(
  basicBirthWeightModel,
  engineeredBirthWeightModel,
  engineeredFeatureBirths
)
```

Based on the rPMSEs, we saw that the mean for the Engineered Model was greater than that of the Basic Model, and the standard deviation of the Engineered Model was less than that of the Basic Model.

#### Table 2.5: Comparison of Models' rPMSE
```{r crossVData}
rPMSEs <- cvResults$rPMSEs
PMSETable <- data.frame(
  c(
    mean(rPMSEs$model1),
    sd(rPMSEs$model1)
  ),
  c(
    mean(rPMSEs$model2),
    sd(rPMSEs$model2)
  )
)
colnames(PMSETable) <- c("Basic Model", "Engineered Model")
rownames(PMSETable) <- c("Mean", "SD")
PMSETable
```

```{r crossVPlots}
boxplot(
  list(model1rPMSE = rPMSEs$model1, model2rPMSE = rPMSEs$model2), 
  main = "Fig. 2.6: Comparison of rPMSEs"
)

layout(matrix(c(1, 2, 4, 5), 1, 2, byrow = TRUE))
plot(
  cvResults$predictions$model1,
  cvResults$residuals$model1,
  main = "Fig 2.7.1: Predictions vs Basic Model Res",
  cex.main = 0.8,
  col = adjustcolor("firebrick", 0.5),
  xlab = "Predicted Values",
  ylab = "Basic Model Residuals",
  pch = 16
)
plot(
  cvResults$predictions$model2,
  cvResults$residuals$model2,
  main = "Fig 2.7.2: Predictions vs Engineered Model Res",
  cex.main = 0.8,
  col = adjustcolor("firebrick", 0.5),
  xlab = "Predicted Values",
  ylab = "Engineered Model Residuals",
  pch = 16
)
```

Then, by plotting the Q-Q Plots of residuals of the predicted values vs actual residuals, we found that both models showed evidence of Normality, but for lighter babies, erred on the side of over-predicting their weight, and for heavier babies, erred on the side of under-predicting their weight. See Appendix 3.3.1.

We then looked at the residual plots. Plotting residuals against fitted values, we saw evidence of the data not showing any non linear relationships in both models.

By plotting the Normal Q-Q Plot, we found strong evidence of Normality of the errors in both models.

```{r qq}
par(mfrow = c(1, 2))
qqnorm(
  cvResults$residuals$model1,
  main = "Fig. 2.8.1: Normal Q-Q Plot for Basic",
  cex.main = 0.85,
  pch = 16,
  col = adjustcolor("firebrick", 0.5)
)
abline(a = 0, b = 20, lty = 2, lwd = 2, col = "blue")

qqnorm(
  cvResults$residuals$model2,
  main = "Fig. 2.8.2: Normal Q-Q Plot for Engineered",
  cex.main = 0.85,
  pch = 16,
  col = adjustcolor("firebrick", 0.5)
)
abline(a = 0, b = 20, lty = 2, lwd = 2, col = "blue")
```

Comparing the different diagnostics of the two models, it was evident that the statistical diagnostic of the two models was very similar. However, by taking a look at the residual standard error, coefficients of determination, and PRESS statistic, the Engineered Model was a slightly better model compared to the Basic Model. However it was a lot more computationally complex than the Basic Model, but since we are more interested in our model's predictive power for the purpose of this report, the Engineered Model will be selected as the final model and will be used for the discussion portion.

# Discussion

## Significance

Looking at the p-values of the Engineered Model in Appendix 3.3.5, the most important factors that affected a baby's birth weight is the time since the mother quit smoking, the mother's ethnicity, the mother's height, the mBMI, and the parity, with the most significant being the mother's ethnicity and height.

## Behavioural Recommendations

By comparing the different p-values and betas of the coefficients of the Engineered model, some behaviours most associated with birth weight are smoking and maintaining a high BMI. However, it would be incorrect to draw a causal link that would let us recommend behavioural changes.

## High p-values

Looking at Appendix 3.3.5, we saw that there were many factors associated with a relatively high p-value: the mother's ethnicity when she's Mexican, Mixed or Other and the time since the mother quit smoking if she Still Smokes, if she Quit Less Than a Year Ago, 2-3 Years Ago, 3-4 Years Ago, 5-9 Years Ago or she Quit But Doesn't Know When.

There were two reasons not to remove these variables, the first being that the removal of the variable could result in the removal of a significant covariate. For example, when the mother is Mixed, the p-value is very high. However, we cannot remove the mother's ethnicity as a factor because that would remove other significant covariates, such as the mother's ethnicity when she is African-American.

The second reason we did not remove these variables was because of the percentage of the population that fell under those categories. For example, the number of people who Quit But Didn't Know When was very small: only 0.4%, as seen in Appendix 3.3.7. This results in a large p-value as their results are less representative of the population than that of a more significant sample.

## Regression Assumptions

Looking at Appendix 3.3.6, we see that the Residual vs Fitted plot has a relatively horizontal line, indicating that the linearity of data assumption has been preserved. We also see that the residuals roughly follow a Normal distribution from the Q-Q Plot.  
The Scale-Location Plot shows a horizontal line, slightly curved downward. Furthermore, the spread of the points is close to equal, with there being slightly more points above the line. Overall, the homoscedasticity of variance assumption is preserved. See Appendix 3.3.6.

\pagebreak

# Appendix

```{r setupAppendix, include = FALSE, cache = FALSE}
# Reconfigure Knitr for Appendix
knitr::opts_chunk$set(include = TRUE, echo = TRUE, eval = FALSE)
```

## Section 1: Constants and Functions

### Chunk 1

Defines all of the constants. Executes at the top of the file.
```{r ref.label = "constants"}
```

### Chunk 2

Defines functions related to BMI. Executes immediately after Chunk 1.
```{r ref.label = "bmiFunctions"}
```

### Chunk 3

Defines the function to calculate the number of cigarettes smoked per day corresponding to a 'number' value. Executes immediately after Chunk 2.
```{r ref.label = "numCigs"}
```

### Chunk 4

Defines the function used to process the raw data into a dataset with factors which is used by the Basic Model. Executes immediately after Chunk 3.
```{r ref.label = "decodeBirthVariates"}
```

### Chunk 5

Defines the function which calculates our engineered smoking impact feature. Executes immediately after Chunk 4.
```{r ref.label = "smokingImpact"}
```

### Chunk 6

Defines the function used to process the raw data into a dataset with factors and all of our engineered features. Executes immediately after Chunk 5.
```{r ref.label = "engineeredFeatures"}
```

### Chunk 7

Defines the function used to compute the average AIC of a model across the multiple imputed datasets. Executes immediately after Chunk 6.
```{r ref.label = "meanAIC"}
```

### Chunk 8

Defines the function used to perform automated model selection. Executes immediately after Chunk 7.
```{r ref.label = "selectModel"}
```

### Chunk 9

Defines the function used to perform cross-validation between our models. Executes immediately after Chunk 8
```{r ref.label = "crossValidate"}
```

## Section 2: Dataset Creation

### Chunk 1

Imports our raw data. Executes immediately after Chunk 9 of Section 1 (this is still all at the top of the Report before any text.)
```{r ref.label = "import"}
```

### Chunk 2

Corrects a transcription error. Executes immediately after Chunk 1.
```{r ref.label = "mend"}
```

### Chunk 3

Multiply imputes our dataset. Executes immediately after Chunk 2.
```{r ref.label = "mice"}
```

### Chunk 4

Uses decodeBirthVariates to create the first model's datasets from the multiply imputed datasets. Executes immediately after Chunk 3.
```{r ref.label = "decodeBirths"}
```

### Chunk 5

Finds the optimal value for the impactHalfLife parameter. Executes immediately after Chunk 4.
```{r ref.label = "tuneHalfLife", eval = TRUE}
```

### Chunk 6

Uses the craftFeatures function to create the second model's datasets from the multiply imputed datasets. Executes immedately after Chunk 4.
```{r ref.label = "craftFeatures"}
```

## Section 3: Figures

### Figure 1.1

Produces a pair plot of the variables birth weight, mother height, mother weight, time (since quitting smoking), and number (number of cigarettes smoke per day while smoking). Appears in Data Exploration.
```{r ref.label = "1"}
```

### Figure 1.2

Produces a histogram displaying the percent of the population each birth weight represents with a Normal distribution curve superimposed. Appears in Data Exploration.
```{r ref.label = "2"}
```

### Figure 1.3

Produces a plot of mother's ethnicity against birth weight. Discussed in Data Exploration.

```{r 3}
plot(
  births$meth,
  births$wt,
  col = adjustcolor("firebrick", 0.25),
  pch = 16,
  main = "Fig 1.3: Mother's Ethnicity vs Birth Weight",
  xlab = "Mother's Ethnicity",
  ylab = "Birth Weight (ounces)",
  mar = c(1, 4, 1, 2) + 0.1
)
```

### Figure 1.4

Produces a plot of parity against birth weight. Discussed in Data Exploration.
```{r 4}
plot(
  births$parity,
  births$wt,
  pch = 16,
  col = adjustcolor("firebrick", 0.25),
  main = "Fig. 1.4: Parity vs Birth Weight",
  xlab = "Parity",
  ylab = "Birth Weight (ounces)"
)
```

### Figure 1.5.{1, 2, 3, 4}

Produces plots of mother's education level, father's education level, mother's age at the termination of the pregnancy and household income against birth weight. Discussed in Data Exploration. 
```{r 5}
par(mfrow = c(1, 2))
plot(
  births$med,
  births$wt,
  col = adjustcolor("firebrick", 0.25),
  pch = 16,
  cex.main = 0.75,
  cex.lab = 0.75,
  main = "Fig 1.5.1: Mother's Education vs Birth Weight",
  xlab = "Mother's Education",
  ylab = "Birth Weight (ounces)"
)
plot(
  births$fed,
  births$wt,
  col = adjustcolor("firebrick", 0.25),
  pch = 16,
  cex.main = 0.75,
  cex.lab = 0.75,
  main = "Fig. 1.5.2: Father's Education vs Birth Weight",
  xlab = "Father's Education",
  ylab = "Birth Weight (ounces)"
)
plot(
  births$mage,
  births$wt,
  pch = 16,
  cex.main = 0.75,
  cex.lab = 0.75,
  col = adjustcolor("firebrick", 0.25),
  main = "Fig. 1.5.3: Mother's Age vs Birth Weight",
  xlab = " Mother's Age",
  ylab = "Birth Weight (ounces)"
)
plot(
  births$income,
  births$wt,
  pch = 16,
  cex.main = 0.75,
  cex.lab = 0.75,
  col = adjustcolor("firebrick", 0.25),
  main = "Fig. 1.5.4: Household Income vs Birth Weight",
  xlab = "Household Income (USD)",
  ylab = "Birth Weight (ounces)"
)
```

### Figure 1.6.{1, 2}

Produces a plot of the birth weight against the difference in height of the parents. Also prints the mean birth weight when the father is taller than the mother and vice versa. Appears in Data Exploration.
```{r ref.label = "6"}
```

### Figure 1.7

Produces a plot of the birth weight against the BMI of the mother. Appears in Data Exploration.
```{r ref.label = "BMI"}
```

### Figure 1.8

Produces a plot of gestation period against birth weight. Appears in Data Exploration.
```{r ref.label = "gestation"}
```

### Table 1.9

Produces a table of the number of occurrences per marital status category. Appears in Outliers.
```{r ref.label = "outliers"}
```

### Table 1.10

Produces a table of the percentage of NAs in the dataset by variable. Appears in Missing Data.
```{r ref.label = "NAs"}
```

### Table 2.1

Produces a table of Residual Standard Error, $R^2$ and $R^2$ adjusted values for both models. Appears in Model Diagnostics.
```{r ref.label = "summaryStatistics"}
```

### Figure 2.2

Produces a plot of residuals for the Basic Model. Appears in Diagnostic Plots.
```{r ref.label = "plotDiagnostic1"}
```


### Figure 2.3

Produces a plot of residuals for the Engineered Model. Appears in Diagnostic Plots.
```{r ref.label = "plotDiagnostic2"}
```

### Table 2.4

Produces a table of AIC and PRESS Statistic value for both models. Appears PRESS Statistic and AIC.
```{r ref.label = "PRESSandAIC"}
```

### Table 2.5

Produces a table of the mean and standard deviations for each model's rPMSE. Appears in Cross Validation.
```{r ref.label = "crossVData"}
```

### Figure 2.{6, 7}

2.6 produces a boxplot comparison of both rPMSEs. Appears in Cross Validation. 2.7 produces plots of residuals vs fitted values for each model. Appears in Cross Validation.
```{r ref.label = "crossVPlots"}
```

### Figure 2.8

Produces a Normal Q-Q plot for both models. Appears in Cross Validation.
```{r ref.label = "qq"}
```


### Figure 3.1

Produces a Q-Q Plot of ground truth baby birth weights against predicted values. Appears in Cross Validation.
```{r extraQQ, eval = TRUE}
qqplot(
  cvResults$predictions$model1,
  cvResults$actual,
  main = "Q-Q Plot",
  xlab = "Predicted Values",
  ylab = "Actual Values"
)
abline(a = 0, b = 1, lty = 2, col = "red")

qqplot(
  cvResults$predictions$model2,
  cvResults$actual,
  main = "Q-Q Plot",
  xlab = "Predicted Values",
  ylab = "Actual Values"
)
abline(a = 0, b = 1, lty = 2, col = "red")
```

### Figure 3.2

Produces a Cook's Distance plot for Basic Model. Discussed in Diagnostic Plots.
```{r leverage1, eval = TRUE}
plot(basicBirthWeightModel, cex = 0.4, which = c(4, 4), pch = 19, lwd = 2, main = NULL)
```

### Figure 3.3

Cook's Distance plot for Engineered Model. Discussed in Diagnostic Plots.
```{r leverage2, eval = TRUE}
plot(engineeredBirthWeightModel, cex = 0.4, which = c(4, 4), pch = 19, lwd = 2, main = NULL)
```

### Table 3.4 - Basic Model Coefficients

Produces a summary table of the Basic Model.
```{r pValue1, eval = TRUE}
# Basic coefficients
basicCoeff <- data.frame(summary(basicBirthWeightModel)$coefficients)

format(round(basicCoeff, 3), digits = 2, scientific = FALSE)
```

### Table 3.5 - Engineered Model Coefficients

Produces a summary table of the Engineered Model. Appears in Discussion.
```{r pValue2, eval = TRUE}
# Engineered coefficients
enginCoeff <- data.frame(summary(engineeredBirthWeightModel)$coefficients)
format(round(enginCoeff, 3), digits = 2, scientific = FALSE)
```

### Figure 3.6.{1, 2, 3}

Produces a Residual vs Fitted, Normal Q-Q, and Scale-Location plot for the Engineered Model. Appears in Discussion.
```{r summaryPlots2, eval = TRUE}
plot(engineeredBirthWeightModel, cex = 0.4, which = c(1, 2, 3), pch = 19, lwd = 2, main = NULL)
```

### Table 3.7

Produces a table of the percentage of entries in each category for time. Appears in Discussion.
```{r percentTime}
# Percentage of entries in each category for time
percentTime <- data.frame(c(0, 1, 2, 3, 4, 5, 6, 7, 8, 9), 
           sapply(0:9, function(i) sum(na.omit(births$time == i))/N))
colnames(percentTime) <- c("Category Corresponding to Time", "Percentage of the Population")
percentTime
```

## Section 4: Model Selection

### Chunk 1

Finds the best model as chosen by automated model selection on the basic dataset. Discussed and executes in the Candidate Model 1 section.
```{r ref.label = "model1"}
```

### Chunk 2

Finds the best model including via automated model selection on dataset with added engineered features. Discussed and executes in the Candidated Model 2 section.
```{r ref.label = "model2"}
```

### Chunk 3

Performs cross-validation to compare candidate models. Executes in the Cross Validation section.
```{r ref.label = "crossValidation"}
```

# References

Dovey, D. (2016). Does Race Affect Weight? BMI Differs Among The Races According To Muscle Mass And Fat Distribution. https://www.medicaldaily.com/does-race-affect-weight-bmi-differs-among-races-according-muscle-mass-and-fat-397199?fbclid=IwAR1zY9LfbIQbdz7KSh03FYUMBumtoT3El7N6cSagIqj1hjLgnmPI6m57emA

Gold, K., DeMonner, S., Lantz, P. and Hayward, R. (2010). Prematurity and Low Birth Weight as Potential Mediators of Higher Stillbirth Risk in Mixed Black/White Race Couples. https://www.ncbi.nlm.nih.gov/pmc/articles/PMC2867623/

Stulp, G., Verhulst, S., Pollet, T. Nettle, D. and Buunk, A. (2011) Parental Height Differences Predict the Need for an Emergency Caesarean Section. https://journals.plos.org/plosone/article?id=10.1371%2Fjournal.pone.0020497&fbclid=IwAR0pUDZAm8H_W18vp8kgHWgeR7TpA36SENZW-hQ3KNDWe20O6Qj42giOvy4.

Wilson, D. (2018). What's the Best Age to Get Pregnant?. https://www.healthline.com/health/pregnancy/best-age-to-get-pregnant?fbclid=IwAR3a0YPMsveJAL6u_QlyxOosYESKd2heifu1dh_VZbprF3UJ2YN4sd6AEpc.

Woolston, C. (n.d.). How smoking during pregnancy affects you and your baby. https://www.babycenter.com/0_how-smoking-during-pregnancy-affects-you-and-your-baby_1405720.bc?fbclid=IwAR2jTMTlW9fh-GH2I5asb1x584dbvC4BpA-oTvIGfcd0t_gVYurZYB4vyTY.

Health Impact of Smoking. (n.d.). https://www.med.uottawa.ca/sim/data/Smoking_and_Health_e.htm.

Pregnancy weight gain: What's healthy?. (2017). https://www.mayoclinic.org/healthy-lifestyle/pregnancy-week-by-week/in-depth/pregnancy-weight-gain/art-20044360?pg=1.



