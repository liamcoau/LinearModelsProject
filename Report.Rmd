---
title: "Predicting Newborn Weight"
author: Liam Coleman-Aulenbach, Venessa Keung, Lucy Wang
output: pdf_document
documentclass: article
---

```{r setup, include=FALSE}
# Knitr Configuration
knitr::opts_chunk$set(include=FALSE, results="hide")
```

```{r import}
# Import
births <- read.csv("chds_births.csv")
```

# Summary

The purpose of this study was to determine what factors affect a male baby's birth weight with information readily available when the couple conceives. A sample of 1236 newborn males was conducted and information was taken via a survey of the mothers. The factors considered in this study were mother's age, mother's weight, father's ethnicity, the amount of time since the mother had stopped smoking, and parity. Furthermore, we engineered variables showing the mothers' pregnancy BMI, a smoking index to reflect the affects of smoking on the mothers' bodies, whether or not the parents were of the same ehtnicity, and the height difference between the father and the mother either because the given variates were not an accurate predictor of health, or because we thought they would also be predictors of a baby's weight. Results of the study show that ______.


# Model Selection

## Data Diagnostic

### Data Exploration
Looking at the data beforehand, we tried to test if any of the variables that would be assumed to have a relationship with baby weight had a relationship in the context of the data. 

```{r 1}
pairs(births[c("wt", "mht", "mwt","time", "number")], col=adjustcolor("firebrick", 0.2), pch=19)
```
We found that the babies' weight had a positive relationship with the mothers' weight as well as with the mothers' height. We also see that the mothers' height has a positive relationship with the mothers' height.

We also tried to find the distribution of the babies' weight. In doing so, we tested to see if the babies' weight followed a Normal distribution. If it did not, we would have had to apply an affine transformation to the data to make it follow a Normal distribution.
```{r 2}
hist(births$wt, breaks=100, col = "firebrick") 
```
Looking at the data, we see that the distribution of the babies' weight is close to Normal, but has spikes in frequency in certain areas.

We then decided to test the relationship between the mothers' ethnicity and the babies' weight. According to a 2009 study published in the British Journal of Nutrition, BMI was found to be an inaccurate measurement for non-white individuals. BMI, as a measure of weight proportional to the area of an individual's body, was found to differ among races. Hence, it seems to be a viable factor when considering the weight of a newborn baby.

```{r 3}
plot(births$meth, births$wt, col=adjustcolor("firebrick", 0.5), pch=16) #mother's ethnicity vs weight
```
However, based on the data, there was no evidence of a linear relationship between only the mothers' ethnicity and the babies' weight.

Next, we tested for a relationship between parity and the babies' weight. As a mother's body adjusts to pregnancy, it would make sense for the babies' weight to be affected.
```{r 4}
plot(births$parity, births$wt, pch=16, col="firebrick") 

round(sapply(0:13, function (parity) c(mean(births[births$parity==parity, "wt"]), sd(births[births$parity==parity, "wt"]))), 2)

```
Based on the data, we see no evidence of a linear relationship between only babies' weight and parity.

Finally, we tested for a relationship between the mothers' education level, fathers' education level, mothers' age at the termination of the pregnancy, and household income with the babies' weight. A household with a higher income would be able to provide more resources to a pregnant mother and would have a higher likelihood of having a healthy mother, who would likely give birth a baby with a healthy baby weight. A household with a higher income would likely have a highly educated mother, or highly educated father, or both.

We also tested for a relationship between mothers' education level and fathers' education level. A mother with a lower education level, which would make sense given that the data is taken from 1960-1967, may be more inclined to marry a man with a higher education level in order to provide for herself and a future child.
```{r 5}
plot(births$med, births$wt, col=adjustcolor("firebrick", 0.5), pch=16)
plot(births$fed, births$wt, col=adjustcolor("firebrick", 0.5), pch=16) 
plot(births$mage, births$wt, pch=16, col="firebrick") 
plot(births$income, births$wt, pch=16, col="firebrick") 
plot(births$med, births$fed, col=adjustcolor("firebrick", 0.5), pch=16)
```
However, we see that none of the tested variables: mothers' education level, fathers' education level, mothers' age  at the termination of pregnancy, or household income have a linear relationship with the babies' weight.

We also found that there was no a relationship between the mothers' education levels and the fathers' education level. 

We also tried to test if any of the engineered variables: difference between father and mother height, and BMI, had a relationship with weight.

According to a 2011 study, it was found that a difference between parental height contributed to whether or not the mother would require an Emergency Cesarean Section (ECS). Since ECS can be used when a baby is too big for the birth canal or to save the baby in before it comes to term, there is a possibility that it is related to birth weight.

```{r 6}
#lm(wt ~ I(fht - mht), data=data)
plot(births$mht, births$fht, col=adjustcolor("firebrick", 0.25), pch=16)
abline(coef=c(0, 1))
plot(births$fht < births$mht, births$wt, col=adjustcolor("firebrick", 0.5), pch=16)
mean(na.omit(births[births$fht < births$mht, ]$wt)) #mean for when mom is shorter than dad
mean(na.omit(births[!(births$fht < births$mht), ]$wt)) #mean for when dad is shorter than mom
```
Looking at the heights of the mothers and the fathers, we see that majority of the couples had fathers who were taller than the mothers. It is also worth nothing that the mean baby weight when the father is taller than the mother is greater than the mean baby weight when the mother is taller than the father. This suggests a possible relationship between the difference in heights.

``` {r diffInHeight}
plot(births$fht - births$mht, births$wt, pch=16, col="firebrick")
```

BMI, as a relatively good indicator of health, would theoretically be a good indicator of health of a newborn baby. We want to look at the mothers' BMI to see whether that would have a relationship with the baby's newborn weight.
```{r BMI}
plot(births$mwt / I(births$mht)^2, births$wt, pch=16, col="firebrick") 
```
Based on the data, there does not appear to be a relationship between only the difference in parental height and the babies' weight. However, there appears to be a small positive relationship between the mothers' BMI and the babies' weight.


We did not consider gestation as a factor of birth weight because it was not something that the couple could know at conception of the baby. 
```{r trial}
plot(births$gestation, births$wt)
summary(lm(wt ~ gestation, data=births)) 
```
We also found that gestation was very closely related to births, indicating that predicting gestation period is conceptually similar to predicting birth weight.

### Outliers
We discovered some values outside of the defined encodings. For example, in the marital column there were two 0s, which have no corresponding marital status. We overwrote those (likely) transcription errors with NAs which were later filled in with multiple imputation.
```{r outliers}
#sum(na.omit(births$meth > 10 | births$meth < 0))
#sum(na.omit(births$feth > 10 | births$meth < 0))
#sum(na.omit(births$med > 7 | births$med < 0))
#sum(na.omit(births$fed > 7 | births$med < 0))
#sum(na.omit(births$marital > 5 | births$marital < 1))
#sum(na.omit(births$income > 9 | births$income < 0))
#sum(na.omit(births$smoke > 3 | births$smoke < 0))
#sum(na.omit(births$time > 9 | births$time < 0))
#sum(na.omit(births$number > 9 | births$number < 0))

"meth"
summary(factor(births$meth))
"feth"
summary(factor(births$feth))
"med"
summary(factor(births$med))
"fed"
summary(factor(births$fed))
"marital"
summary(factor(births$marital))
"income"
summary(factor(births$income))
"smoke"
summary(factor(births$smoke))
"time"
summary(factor(births$time))
"number"
summary(factor(births$number))

mendedBirths <- data.frame(births)
mendedBirths[mendedBirths$marital == 0, "marital"] <- NA
#mendedBirths$number <- mendedBirths$number - 1 * (mendedBirths$number == 8)
#summary(factor(mendedBirths$number))
```


### Missing Data

```{r NAs}
N <- nrow(mendedBirths)
round(sapply(colnames(mendedBirths), function (colname) sum(is.na(mendedBirths[colname])) / N), 2)

nrow(na.omit(mendedBirths[, !(colnames(mendedBirths) %in% c("fht", "fwt", "income"))])) / N

nrow(na.omit(mendedBirths[, !(colnames(mendedBirths) %in% c("fht", "fwt", "income"))])) / N
```

## Data Preprocessing

### Filling Missing Values

```{r mice}
library(mice)
k <- 5

multiplyImputedBirths <- mice(mendedBirths, m = k, method = "pmm", seed = 500, printFlag = FALSE)

imputedBirths <- lapply(1:k, function(i) complete(multiplyImputedBirths, i))
```


### Decoding

```{r preprocessData}
numCigs <- function (number) (number <= 4) * (5 * number - 2.5) + (number > 4) * (10 * number - 25.5)

# Re-encoding and labelling variates
decodeBirthVariates <- function (birthsDataset) {
  newDataset = data.frame(birthsDataset)

  ethLabels <- c(
    "Caucasian",
    "Mexican",
    "African-American",
    "Asian",
    "Mixed",
    "Other"
  )
  edLabels <- c(
    "Elementary School",
    "Middle School",
    "High School",
    "High School + Trade School",
    "High School + Some College",
    "College Graduate",
    "Trade School",
    "High School Unclear"
  )

  newDataset$meth <- cut(
    birthsDataset$meth,
    breaks = c(0, 5:10), 
    labels = ethLabels,
    right = TRUE,
    include.lowest= TRUE
  )

  newDataset$med <- cut(
    birthsDataset$med,
    breaks = 0:8, 
    labels = edLabels,
    right = FALSE
  )

  newDataset$feth <- cut(
    birthsDataset$feth,
    breaks = c(0, 5:10),
    labels = ethLabels,
    right = TRUE,
    include.lowest= TRUE
  )

  newDataset$fed <- cut(
    birthsDataset$fed,
    breaks = 0:8, 
    labels = edLabels,
    right = FALSE
  )

  newDataset$smoke <- cut(
    birthsDataset$smoke,
    breaks = 0:4, 
    labels = c(
      "Never",
      "Smokes Now",
      "Until Pregnancy",
      "Doesn't Smoke Anymore"
    ),
    right = FALSE
  )

  newDataset$marital <- cut(
    birthsDataset$marital,
    breaks = 0:5,
    labels = c(
      "Married",
      "Legally Separated",
      "Divorced",
      "Widowed",
      "Never Married"
    )
  )

  newDataset$number <- numCigs(birthsDataset$number)

  newDataset$time <- cut(
    birthsDataset$time,
    breaks = 0:10,
    labels = c(
      "Never Smoked",
      "Still Smokes",
      "During Pregnancy",
      "Less Than A Year",
      "1-2 Years",
      "2-3 Years",
      "3-4 Years",
      "5-9 Years",
      "More Than 10 Years",
      "Quit But Don't Know When"
    ),
    right = FALSE
  )

  newDataset$income <- cut(
    birthsDataset$income,
    breaks = c(0, 1, 2, 10),
    labels = c(
      "Under 2500",
      "2500-4999",
      "5000-Over 25000"
    ),
    right = FALSE
  )

  newDataset
}
```

```{r craftFeatures}
poundsToKg <- 0.453592
inchesToM <- 0.0254
#https://www.mayoclinic.org/healthy-lifestyle/pregnancy-week-by-week/in-depth/pregnancy-weight-gain/art-20044360?pg=1
underweightNormalBoundary <- 18.5
normalOverweightBoundary <- 25
overweightObeseBoundary <- 30
#obeseWeightGain <- mean(c(11, 20))
#overweightWeightGain <- mean(c(15, 25))
#normalWeightGain <- mean(c(25, 30))
#underweightWeightGain <- mean(c(28, 40))
isUnderweight <- function (x) x < underweightNormalBoundary
isNormal <- function (x) x < normalOverweightBoundary & x >= underweightNormalBoundary
isOverweight <- function (x) x < overweightObeseBoundary & x >= normalOverweightBoundary
isObese <- function (x) x >= overweightObeseBoundary

bmi <- function (wtLbs, htIn) (wtLbs * poundsToKg) / (htIn * inchesToM)^2
#obesePrePregnancyBMI <- function (pregnancyWt, ht) bmi(pregnancyWt - obeseWeightGain, ht)
#overweightPrePregnancyBMI <- function (pregnancyWt, ht) bmi(pregnancyWt - overweightWeightGain, ht)
#normalPrePregnancyBMI <- function (pregnancyWt, ht) bmi(pregnancyWt - normalWeightGain, ht)
#underweightPrePregnancyBMI <- function (pregnancyWt, ht) bmi(pregnancyWt - underweightWeightGain, ht)

prePregnancyBMI <- function (pregnancyWt, ht) {
  attemptOrder = sample(
    list(
      c(obesePrePregnancyBMI, isObese),
      c(overweightPrePregnancyBMI, isOverweight),
      c(normalPrePregnancyBMI, isNormal),
      c(underweightPrePregnancyBMI, isUnderweight)
    ),
    4
  )
  
  for (bmiCategoryPair in attemptOrder) {
    if (bmiCategoryPair[[2]](bmiCategoryPair[[1]](pregnancyWt, ht))) {
      return(bmiCategoryPair[[1]](pregnancyWt, ht))
    }
  }
}

weightFromBMI <- function (prePregnancyBMI, ht) {
  (1 / poundsToKg) * prePregnancyBMI * (ht * inchesToM)^2
}

smokingImpact <- function (time, number) {
  cigaretteEffectRatio = 6
  # Take the average of the bounds of the range of cigarettes smoked by a given category
  # as the approximate exact number of cigarettes smoked per day
  # https://www.med.uottawa.ca/sim/data/Smoking_and_Health_e.htm shows that it took a
  # six-fold increase in the number of cigarettes smoked a day to double the impact
  # on the likelihood of developing lung cancer. We approximate the effect of smoking
  # on birth with this ratio too.
  activeSmokingImpact = (number != 0) * 2^(numCigs(number) / cigaretteEffectRatio)
  
  impactTimeDecay = 2
  
  # Approximate a scalar number of years since quiting based on the categorical variable
  yearsQuit = (time >= 3) * (-2.5 + time) + (time >= 7) * (-18.5 + 3 * time)
  # Time = 1 or 2 are special cases with 0 decay
  yearsQuit = yearsQuit * (time >= 3)
  
  decayedSmokingImpact = activeSmokingImpact * exp(-yearsQuit / impactTimeDecay)
  
  decayedSmokingImpact
}

craftFeatures <- function (imputedBirthsDataset) {
  newDataset = decodeBirthVariates(imputedBirthsDataset)

  newDataset$sameEth <- factor(
    imputedBirthsDataset$meth == imputedBirthsDataset$feth,
    labels = c("Different", "Same")
  )
  # What about "Other" though?
  
  newDataset$htDiff <- newDataset$fht - newDataset$mht
    
  newDataset$lateMom <- factor(
    newDataset$parity == 0 & newDataset$mage >= 35,
    labels = c("Not late", "Late")
  )

  newDataset$mBMI <- bmi(newDataset$mwt, newDataset$mht)
  
  #newDataset$mwt <- weightFromBMI(newDataset$mBMI, newDataset$mht)
  
  newDataset$mBMICategory <- factor(
    1 * isNormal(newDataset$mBMI)
      + 2 * isOverweight(newDataset$mBMI)
      + 3 * isObese(newDataset$mBMI),
    labels = c("Underweight", "Normal", "Overweight", "Obese")
  )
  
  newDataset$smokingImpact <- smokingImpact(
    imputedBirthsDataset$time,
    imputedBirthsDataset$number
  )
  newDataset$smokingQuitCategory <- factor(
    1 * (imputedBirthsDataset$time == 2) + 2 * (imputedBirthsDataset$time == 1),
    labels = c("Before/Never", "During", "Continued")
  )
  
  newDataset
}

engineeredFeatures <- c(
  "sameEth",
  "htDiff",
  "lateMom",
  "mBMI",
  "mBMICategory",
  "smokingImpact",
  "smokingQuitCategory"
)

engineeredFeatureBirths <- lapply(imputedBirths, craftFeatures)
```

## Candidate Model 1

### Automated Model Selection

```{r selectModel}
meanAIC <- function (model, datasets) mean(sapply(
  datasets,
  function (dataset) AIC(update(model, data = dataset))
))

selectModel <- function (
  datasets,
  predictedVar,
  excludedVars = c(),
  specialTerms = c()
) {
  selectedModelMeanAIC = .Machine$integer.max
  selectedModel = NULL
  
  for (dataset in datasets) {
    #adjustedBirthsDataset <- birthsDataset[, !colnames(birthsDataset) %in% excludedVars]
    M0 = lm(wt ~ 1, data = dataset)
    Mmax = lm(
      formula(paste(
        predictedVar,
        "~",
        "(.",
        Reduce(function (l, r) paste(l, r), Map(function (term) paste("-", term), excludedVars), ""),
        ")^2",
        Reduce(function (l, r) paste(l, r), Map(function (term) paste("+", term), specialTerms), "")
      )),
      data = dataset
    )
    #Mmax <- lm(
    #  wt ~ (. - gestation - marital - time - meth - feth - med - fed)^2 + marital + time + meth + feth + med + fed,
    #  data = adjustedBirthsDataset
    #)
    #Mmax <- lm(wt ~ .^2, data = dataset)
    
    #checking if there are betas that are NA
    #beta.max <- coef(Mmax)
    #names(beta.max)[is.na(beta.max)]
    #anyNA(coef(Mmax))
  
    candidateModel = step(
      # lm(
      # as.formula(paste(
      #   predictedVar,
      #   "~",
      #   "(.",
      #   Reduce(function (l, r) paste(l, r), Map(function (term) paste("-", term), excludedVars), ""),
      #   ")"
      # )),
      # data=dataset
      # ),
      lm(wt ~ 1, data = dataset),
      scope = list(lower = M0, upper = Mmax),
      direction = "both",
      trace = 0
    )
  
    candidateModelMeanAIC = mean(sapply(
      datasets,
      function (dataset) AIC(update(candidateModel, data = dataset))
    ))
  
    if (candidateModelMeanAIC < selectedModelMeanAIC) {
      selectedModel = update(candidateModel, data = dataset)
      selectedModelMeanAIC = candidateModelMeanAIC
    }
  }
  
  selectedModel
}
```

```{r model1}
basicBirthWeightModel <- selectModel(
  decodedImputedBirths,
  "wt",
  excludedVars = c("gestation", "smoke")
)
basicBirthWeightModelMeanAIC <- meanAIC(basicBirthWeightModel, decodedImputedBirths)
```

## Candidate Model 2

### Hand-crafted Features


### Automated Model Selection
```{r model2}
engineeredBirthWeightModel <- selectModel(
  engineeredFeatureBirths,
  "wt",
  c("gestation", "smoke", "time", "smokingQuitCategory", "fht", "mBMICategory"),
  c("time")#, smokingImpact:smokingQuitCategory")
  #c("smokingImpact", "mBMI", "htDiff", "sameEth",  "lateMom")
)
engineeredBirthWeightModelMeanAIC <- meanAIC(
  engineeredBirthWeightModel,
  engineeredFeatureBirths
)
```


# Model Diagnostics

## Significance


## AIC

## Cross-Validation
```{r crossValidate}
testSetRatio = 0.1

crossValidate <- function (model1, model2, datasets) {
  # "Usually about a thousand is fine" - M. Lysy, Nov. 27, 2018
  m = k * 1000

  model1rPMSE <- vector(mode = "numeric", length = m)
  model2rPMSE <- vector(mode = "numeric", length = m)

  for (i in 1:m) {
    chosenSet = datasets[[1 + i %% k]]
    Ntotal = nrow(chosenSet)
    Ntest = floor(Ntotal * testSetRatio)
    outOfSampleIndices = sample(Ntotal, Ntest)
    trainSet = chosenSet[-outOfSampleIndices, ]
    testSet = chosenSet[outOfSampleIndices, ]
    
    model1 = update(model1, data = trainSet)
    model2 = update(model2, data = trainSet)
    outOfSamplePredictions1 = predict(model1, newdata = testSet)
    outOfSamplePredictions2 = predict(model2, newdata = testSet)
    predictionErrors1 = (testSet$wt - outOfSamplePredictions1) ^ 2
    predictionErrors2 = (testSet$wt - outOfSamplePredictions2) ^ 2
    model1rPMSE[i] <- sqrt(sum(predictionErrors1) / Ntest)
    model2rPMSE[i] <- sqrt(sum(predictionErrors2) / Ntest)
  }
  
  data.frame(model1 = model1rPMSE, model2 = model2rPMSE)
}

rPMSEs <- crossValidate(
  basicBirthWeightModel,
  engineeredBirthWeightModel,
  engineeredFeatureBirths
)

paste(mean(rPMSEs$model1), sd(rPMSEs$model1))
paste(mean(rPMSEs$model2), sd(rPMSEs$model2))
boxplot(list(model1rPMSE = rPMSEs$model1, model2rPMSE = rPMSEs$model2))
```

# Discussion



# Appendix
```{r, ref.label=knitr::all_labels(), echo=TRUE, eval=FALSE, include=TRUE}
```
